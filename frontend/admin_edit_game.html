<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Admin • Editar Juego</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      @media (max-width: 768px) {
        .two-col {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h3 class="mb-3">Editar / Eliminar Juego</h3>

      <div class="input-group mb-3" style="max-width: 520px">
        <input
          id="codeInput"
          class="form-control"
          list="codeList"
          placeholder="PC-, SWI-, XBX- o título..."
        />
        <datalist id="codeList"></datalist>
        <button id="loadBtn" class="btn btn-secondary">Cargar</button>
      </div>

      <div id="formBox" class="d-none">
        <div class="alert alert-info py-2">
          Código: <b id="codeView"></b> (no editable)
        </div>
        <div class="two-col">
          <div>
            <label class="form-label">Título</label
            ><input id="title" class="form-control" />
          </div>
          <div>
            <label class="form-label">Plataforma</label>
            <select id="platform" class="form-select">
              <option>PC</option>
              <option>PS</option>
              <option>XBOX</option>
              <option>SWI</option>
              <option>MBL</option>
            </select>
          </div>
          <div>
            <label class="form-label">Fecha lanzamiento</label
            ><input id="release_date" type="date" class="form-control" />
          </div>
          <div>
            <label class="form-label">Steam App ID</label
            ><input id="steam_app_id" type="number" class="form-control" />
          </div>
          <div>
            <label class="form-label">Developer</label
            ><input id="developer" class="form-control" />
          </div>
          <div>
            <label class="form-label">Publisher</label
            ><input id="publisher" class="form-control" />
          </div>
          <div class="col-12">
            <label class="form-label">Trailer URL</label
            ><input id="trailer_url" class="form-control" />
          </div>
          <div class="col-12">
            <label class="form-label">Descripción</label
            ><textarea
              id="description"
              class="form-control"
              rows="4"
            ></textarea>
          </div>
          <div class="col-12">
            <label class="form-label">Géneros</label>
            <div id="genres" class="row g-2"></div>
          </div>
        </div>

        <hr class="my-4" />
        <h5>Imágenes</h5>
        <div id="imgList" class="row g-2"></div>
        <div class="input-group mt-2" style="max-width: 520px">
          <input
            id="imgFiles"
            type="file"
            class="form-control"
            multiple
            accept=".png,.jpg,.jpeg,.webp"
          />
          <button id="uploadBtn" class="btn btn-primary">Subir</button>
        </div>

        <div class="mt-3">
          <button id="save" class="btn btn-primary">Guardar cambios</button>
          <button id="del" class="btn btn-outline-danger ms-2">
            Eliminar juego
          </button>
          <span id="msg" class="ms-3 text-success"></span>
        </div>
      </div>
    </div>

    <script src="assets/js/scripts.js"></script>
    <script>
      requireAdminPage();
      let currentCode = null,
        currentId = null,
        allGenres = [];

      // Autocomplete
      let t = null;
      codeInput.addEventListener("input", () => {
        clearTimeout(t);
        t = setTimeout(async () => {
          const q = codeInput.value.trim();
          if (!q) return;
          const list = await fetch(
            `${API}/games/search-codes?q=${encodeURIComponent(q)}`
          ).then((r) => r.json());
          codeList.innerHTML = list
            .map((i) => `<option value="${i.code}">${i.title}</option>`)
            .join("");
        }, 200);
      });

      async function loadGenres() {
        allGenres = await fetch(API + "/admin/genres", {
          headers: authHeaders(false),
        }).then((r) => r.json());
      }
      function renderGenres(selectedIds) {
        genres.innerHTML = allGenres
          .map(
            (g) => `
        <div class="col-auto"><label class="form-check">
          <input class="form-check-input" type="checkbox" value="${g.id}" ${
              selectedIds.includes(g.id) ? "checked" : ""
            }> ${g.name}
        </label></div>`
          )
          .join("");
      }

      async function loadImages() {
        const files = await fetch(
          `${API}/games/${encodeURIComponent(currentCode)}/images`
        ).then((r) => r.json());
        imgList.innerHTML = files
          .map((u) => {
            const name = u.split("/").pop();
            return `<div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <div class="border rounded p-2 d-flex justify-content-between align-items-center">
            <span class="text-truncate" style="max-width:70%">${name}</span>
            <button class="btn btn-sm btn-outline-danger" data-name="${name}">✕</button>
          </div></div>`;
          })
          .join("");
        [...imgList.querySelectorAll("button")].forEach((btn) => {
          btn.onclick = async () => {
            if (!confirm(`Eliminar ${btn.dataset.name}?`)) return;
            await fetch(
              `${API}/admin/games/${encodeURIComponent(
                currentCode
              )}/images/${encodeURIComponent(btn.dataset.name)}`,
              {
                method: "DELETE",
                headers: authHeaders(false),
              }
            );
            loadImages();
          };
        });
      }

      uploadBtn.onclick = async () => {
        const fd = new FormData();
        [...imgFiles.files].forEach((f) => fd.append("files", f));
        await fetch(
          `${API}/admin/games/${encodeURIComponent(currentCode)}/images`,
          {
            method: "POST",
            headers: { Authorization: "Bearer " + getToken() },
            body: fd,
          }
        );
        imgFiles.value = "";
        loadImages();
      };

      loadBtn.onclick = async () => {
        const code = codeInput.value.trim();
        if (!code) return;
        const g = await fetch(`${API}/games/${encodeURIComponent(code)}`).then(
          (r) => r.json()
        );
        currentCode = g.game_code;
        currentId = g.id;
        codeView.textContent = currentCode;
        title.value = g.title || "";
        platform.value = g.platform || "PC";
        release_date.value = g.release_date
          ? g.release_date.substring(0, 10)
          : "";
        steam_app_id.value = g.steam_app_id || "";
        developer.value = g.developer || "";
        publisher.value = g.publisher || "";
        trailer_url.value = g.trailer_url || "";
        description.value = g.description || "";

        // (MVP) no tenemos un endpoint dedicado para géneros del juego -> lo dejamos vacío o puedes añadirlo luego
        renderGenres([]);
        formBox.classList.remove("d-none");
        await loadImages();
      };

      save.onclick = async () => {
        const genre_ids = [
          ...document.querySelectorAll("#genres input:checked"),
        ].map((i) => Number(i.value));
        const body = {
          title: title.value.trim(),
          platform: platform.value,
          release_date: release_date.value || null,
          developer: developer.value.trim(),
          publisher: publisher.value.trim(),
          trailer_url: trailer_url.value.trim(),
          description: description.value.trim(),
          steam_app_id: steam_app_id.value ? Number(steam_app_id.value) : null,
          genre_ids,
        };
        const r = await fetch(
          `${API}/admin/games/${encodeURIComponent(currentCode)}`,
          {
            method: "PUT",
            headers: authHeaders(),
            body: JSON.stringify(body),
          }
        );
        const j = await r.json();
        if (r.ok) msg.textContent = "Guardado";
        else alert(j.error || "Error");
      };

      del.onclick = async () => {
        if (!confirm("¿Eliminar este juego?")) return;
        const r = await fetch(
          `${API}/admin/games/${encodeURIComponent(currentCode)}`,
          { method: "DELETE", headers: authHeaders(false) }
        );
        if (r.ok) {
          alert("Eliminado");
          location.reload();
        } else alert("No se pudo eliminar");
      };

      loadGenres();
    </script>
  </body>
</html>
