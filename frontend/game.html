<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Juego • Gaming Corner</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-4" id="wrap"></div>

    <script src="assets/js/scripts.js"></script>
    <script>
      const params = new URLSearchParams(location.search);
      const code = params.get("code");

      async function load() {
        const game = await fetch(`${API}/games/${code}`).then((r) => r.json());
        const images = await fetch(`${API}/games/${code}/images`).then((r) =>
          r.json()
        );
        const notes = await fetch(`${API}/games/${code}/patchnotes`).then((r) =>
          r.json()
        );
        const comments = await fetch(`${API}/games/${code}/comments`).then(
          (r) => r.json()
        );

        wrap.innerHTML = `
      <h3>${game.title}</h3>
      <div class="row g-3">
        <div class="col-md-7">
          <div id="imgs">${images
            .map(
              (u) =>
                `<img src="${abs(
                  u
                )}" class="img-fluid mb-2" onerror="this.remove()">`
            )
            .join("")}</div>
          ${
            game.trailer_url
              ? `<div class="ratio ratio-16x9"><iframe src="${game.trailer_url}" allowfullscreen></iframe></div>`
              : ""
          }
          <h5 class="mt-3">Descripción</h5><p>${game.description || ""}</p>
          <h5 class="mt-3">Patch Notes</h5><pre class="bg-white p-3 border">${
            notes?.contents || "—"
          }</pre>
        </div>
        <div class="col-md-5">
          <div class="card mb-3"><div class="card-body">
            <h5>Tu puntuación</h5>
            <select id="rate" class="form-select mb-2">
              <option>1</option><option>2</option><option>3</option><option selected>4</option><option>5</option>
            </select>
            <button class="btn btn-sm btn-primary" id="rateBtn">Actualizar</button>
          </div></div>
          <div class="card"><div class="card-body">
            <h5>Comentarios</h5>
            <div id="clist">${comments
              .map((c) => `<p><b>${c.username}:</b> ${c.content}</p>`)
              .join("")}</div>
            <textarea id="c" class="form-control my-2" placeholder="Escribe tu comentario"></textarea>
            <button class="btn btn-sm btn-success" id="cbtn">Publicar</button>
            <div class="text-danger mt-2 d-none" id="cerr">Debes iniciar sesión</div>
          </div></div>
        </div>
      </div>`;

        document.getElementById("rateBtn").onclick = async () => {
          const r = await fetch(`${API}/games/${code}/rating`, {
            method: "PUT",
            headers: {
              ...authHeaders(),
              Authorization: "Bearer " + getToken(),
            },
            body: JSON.stringify({
              rating: Number(document.getElementById("rate").value),
            }),
          });
          if (!r.ok) alert("Inicia sesión");
        };
        document.getElementById("cbtn").onclick = async () => {
          const txt = document.getElementById("c").value;
          const r = await fetch(`${API}/games/${code}/comments`, {
            method: "POST",
            headers: {
              ...authHeaders(),
              Authorization: "Bearer " + getToken(),
            },
            body: JSON.stringify({ content: txt }),
          });
          if (!r.ok) {
            document.getElementById("cerr").classList.remove("d-none");
            return;
          }
          location.reload();
        };
      }
      load();
    </script>
  </body>
</html>
