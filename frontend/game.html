<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Juego ‚Ä¢ Gaming Corner</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-4" id="wrap"></div>

    <script src="assets/js/scripts.js"></script>
    <script>
      const params = new URLSearchParams(location.search);
      const code = params.get("code");
      const REVIEWS_API = "http://localhost:4000/api";

      async function load() {
        const game = await fetch(`${API}/games/${code}`).then((r) => r.json());
        const images = await fetch(`${API}/games/${code}/images`).then((r) =>
          r.json()
        );
        const notes = await fetch(`${API}/games/${code}/patchnotes`).then((r) =>
          r.json()
        );
        const comments = await fetch(`${REVIEWS_API}/games/${code}/comments`).then(
          (r) => r.json()
        );
        const ratingInfo = await fetch(`${REVIEWS_API}/games/${code}/rating`).then(
          (r) => r.json()
        );

        wrap.innerHTML = `
          <h3>${game.title}</h3>
          <div class="row g-3">
            <div class="col-md-7">
              <div id="imgs">${images
                .map(
                  (u) =>
                    `<img src="${abs(
                      u
                    )}" class="img-fluid mb-2" onerror="this.remove()">`
                )
                .join("")}</div>
              ${
                game.trailer_url
                  ? `<div class="ratio ratio-16x9"><iframe src="${game.trailer_url}" allowfullscreen></iframe></div>`
                  : ""
              }
              <h5 class="mt-3">Descripci√≥n</h5><p>${game.description || ""}</p>
              <h5 class="mt-3">Patch Notes</h5><pre class="bg-white p-3 border">${
                notes?.contents || "‚Äî"
              }</pre>
            </div>
            <div class="col-md-5">
              <div class="card mb-3"><div class="card-body">
                <h5>Tu puntuaci√≥n</h5>
                <select id="rate" class="form-select mb-2">
                  <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                </select>
                <button class="btn btn-sm btn-primary" id="rateBtn">Actualizar</button>
                <hr>
                <div><b>Promedio actual:</b> ‚≠ê ${ratingInfo.promedio || 0} / 5</div>
                <div><small>${ratingInfo.votos || 0} votos</small></div>
              </div></div>

              <div class="card mb-3"><div class="card-body">
                <h5>Comentarios</h5>
                <div id="clist">${comments
                  .map((c) => `<p><b>${c.username}:</b> ${c.content}</p>`)
                  .join("")}</div>
                <textarea id="c" class="form-control my-2" placeholder="Escribe tu comentario"></textarea>
                <button class="btn btn-sm btn-success" id="cbtn">Publicar</button>
                <div class="text-danger mt-2 d-none" id="cerr">Debes iniciar sesi√≥n</div>
              </div></div>

              <div id="adminArea" class="card d-none"><div class="card-body">
                <h5>Comentarios pendientes de aprobaci√≥n</h5>
                <div id="pendingList"></div>
              </div></div>
            </div>
          </div>`;

        // BOT√ìN DE ACTUALIZAR PUNTUACI√ìN
        document.getElementById("rateBtn").onclick = async () => {
          const r = await fetch(`${REVIEWS_API}/games/${code}/rating`, {
            method: "PUT",
            headers: {
              ...authHeaders(),
              Authorization: "Bearer " + getToken(),
            },
            body: JSON.stringify({
              rating: Number(document.getElementById("rate").value),
            }),
          });
          const data = await r.json();
          if (!r.ok) return alert("Inicia sesi√≥n");
          alert(data.message);
          location.reload();
        };

        // CREAR COMENTARIO
        document.getElementById("cbtn").onclick = async () => {
          const txt = document.getElementById("c").value;
          const r = await fetch(`${REVIEWS_API}/games/${code}/comments`, {
            method: "POST",
            headers: {
              ...authHeaders(),
              Authorization: "Bearer " + getToken(),
            },
            body: JSON.stringify({ content: txt }),
          });
          const data = await r.json();
          if (!r.ok) {
            document.getElementById("cerr").classList.remove("d-none");
            return;
          }
          alert(data.message);
          location.reload();
        };

        // üîê Si es admin, mostrar secci√≥n de rese√±as pendientes
        const token = getToken();
        if (token) {
          try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            if (payload.role === "admin") {
              document.getElementById("adminArea").classList.remove("d-none");
              loadPending();
            }
          } catch {}
        }
      }

      // üîÅ Cargar rese√±as pendientes (solo admin)
      async function loadPending() {
        const token = getToken();
        const res = await fetch(`${REVIEWS_API}/admin/comments/pending`, {
          headers: { Authorization: "Bearer " + token },
        });
        const data = await res.json();
        const div = document.getElementById("pendingList");
        if (data.length === 0) {
          div.innerHTML = "<p>No hay comentarios pendientes</p>";
          return;
        }
        div.innerHTML = data
          .map(
            (c) => `
              <div class="border p-2 mb-2">
                <b>${c.username}</b> en <i>${c.title}</i>
                <p>${c.content}</p>
                <button class="btn btn-sm btn-success me-2" onclick="approve(${c.id})">Aprobar</button>
                <button class="btn btn-sm btn-danger" onclick="removeC(${c.id})">Eliminar</button>
              </div>`
          )
          .join("");
      }

      async function approve(id) {
        const token = getToken();
        await fetch(`${REVIEWS_API}/admin/comments/approve/${id}`, {
          method: "PUT",
          headers: { Authorization: "Bearer " + token },
        });
        alert("Comentario aprobado ‚úÖ");
        loadPending();
        load();
      }

      async function removeC(id) {
        const token = getToken();
        await fetch(`${REVIEWS_API}/admin/comments/delete/${id}`, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token },
        });
        alert("Comentario eliminado ‚ùå");
        loadPending();
      }

      load();
    </script>
  </body>
</html>
